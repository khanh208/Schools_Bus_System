-- ============================================
-- SCHOOL BUS MANAGEMENT SYSTEM - DATABASE SCHEMA
-- PostgreSQL with PostGIS extension
-- ============================================

-- Enable PostGIS extension for geospatial data
CREATE EXTENSION IF NOT EXISTS postgis;

-- ============================================
-- 1. AUTHENTICATION & USERS
-- ============================================

-- User roles enum
CREATE TYPE user_role AS ENUM ('admin', 'driver', 'parent');

-- Users table
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(150) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    role user_role NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    avatar_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    CONSTRAINT chk_phone CHECK (phone ~ '^\+?[0-9]{10,15}$')
);

-- Driver details
CREATE TABLE drivers (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    license_number VARCHAR(50) UNIQUE NOT NULL,
    license_expiry DATE NOT NULL,
    vehicle_id INTEGER,
    experience_years INTEGER DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 5.00,
    status VARCHAR(20) DEFAULT 'available', -- available, on_trip, off_duty
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_rating CHECK (rating >= 0 AND rating <= 5)
);

-- Parent details
CREATE TABLE parents (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    address TEXT,
    emergency_contact VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- 2. STUDENTS & CLASSES
-- ============================================

-- Classes
CREATE TABLE classes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    grade_level INTEGER NOT NULL,
    room_number VARCHAR(20),
    teacher_name VARCHAR(255),
    academic_year VARCHAR(20) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_grade CHECK (grade_level >= 1 AND grade_level <= 12)
);

-- Areas/Zones
CREATE TABLE areas (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    boundary GEOMETRY(Polygon, 4326), -- Geographic boundary using PostGIS
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Students
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    student_code VARCHAR(50) UNIQUE NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    date_of_birth DATE NOT NULL,
    gender VARCHAR(10),
    class_id INTEGER REFERENCES classes(id),
    area_id INTEGER REFERENCES areas(id),
    parent_id INTEGER REFERENCES parents(id),
    address TEXT NOT NULL,
    pickup_location GEOMETRY(Point, 4326) NOT NULL,
    dropoff_location GEOMETRY(Point, 4326) NOT NULL,
    photo_url VARCHAR(500),
    special_needs TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_gender CHECK (gender IN ('male', 'female', 'other'))
);

-- ============================================
-- 3. VEHICLES & ROUTES
-- ============================================

-- Vehicles
CREATE TABLE vehicles (
    id SERIAL PRIMARY KEY,
    plate_number VARCHAR(20) UNIQUE NOT NULL,
    vehicle_type VARCHAR(50) NOT NULL,
    capacity INTEGER NOT NULL,
    model VARCHAR(100),
    year INTEGER,
    color VARCHAR(50),
    insurance_expiry DATE,
    last_maintenance DATE,
    gps_device_id VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_capacity CHECK (capacity > 0)
);

-- Routes
CREATE TABLE routes (
    id SERIAL PRIMARY KEY,
    route_code VARCHAR(50) UNIQUE NOT NULL,
    route_name VARCHAR(255) NOT NULL,
    description TEXT,
    route_type VARCHAR(20) NOT NULL, -- pickup, dropoff, both
    area_id INTEGER REFERENCES areas(id),
    vehicle_id INTEGER REFERENCES vehicles(id),
    driver_id INTEGER REFERENCES drivers(id),
    estimated_duration INTEGER, -- in minutes
    total_distance DECIMAL(10,2), -- in km
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_route_type CHECK (route_type IN ('pickup', 'dropoff', 'both'))
);

-- Route stops
CREATE TABLE route_stops (
    id SERIAL PRIMARY KEY,
    route_id INTEGER REFERENCES routes(id) ON DELETE CASCADE,
    stop_order INTEGER NOT NULL,
    stop_name VARCHAR(255) NOT NULL,
    location GEOMETRY(Point, 4326) NOT NULL,
    estimated_arrival TIME,
    estimated_departure TIME,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uk_route_stop_order UNIQUE(route_id, stop_order)
);

-- Student route assignments
CREATE TABLE student_routes (
    id SERIAL PRIMARY KEY,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    route_id INTEGER REFERENCES routes(id),
    stop_id INTEGER REFERENCES route_stops(id),
    assignment_type VARCHAR(20) NOT NULL, -- pickup, dropoff, both
    start_date DATE NOT NULL,
    end_date DATE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_assignment_type CHECK (assignment_type IN ('pickup', 'dropoff', 'both'))
);

-- ============================================
-- 4. SCHEDULES
-- ============================================

-- Route schedules
CREATE TABLE route_schedules (
    id SERIAL PRIMARY KEY,
    route_id INTEGER REFERENCES routes(id) ON DELETE CASCADE,
    day_of_week INTEGER NOT NULL, -- 0=Monday, 6=Sunday
    start_time TIME NOT NULL,
    end_time TIME,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_day_of_week CHECK (day_of_week >= 0 AND day_of_week <= 6)
);

-- ============================================
-- 5. TRIPS & TRACKING
-- ============================================

-- Trips
CREATE TABLE trips (
    id SERIAL PRIMARY KEY,
    route_id INTEGER REFERENCES routes(id),
    driver_id INTEGER REFERENCES drivers(id),
    vehicle_id INTEGER REFERENCES vehicles(id),
    trip_date DATE NOT NULL,
    trip_type VARCHAR(20) NOT NULL, -- morning_pickup, afternoon_dropoff
    scheduled_start_time TIMESTAMP NOT NULL,
    actual_start_time TIMESTAMP,
    scheduled_end_time TIMESTAMP,
    actual_end_time TIMESTAMP,
    status VARCHAR(20) DEFAULT 'scheduled', -- scheduled, in_progress, completed, cancelled
    total_students INTEGER DEFAULT 0,
    checked_in_students INTEGER DEFAULT 0,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_trip_type CHECK (trip_type IN ('morning_pickup', 'afternoon_dropoff')),
    CONSTRAINT chk_trip_status CHECK (status IN ('scheduled', 'in_progress', 'completed', 'cancelled'))
);

-- GPS tracking logs
CREATE TABLE location_logs (
    id SERIAL PRIMARY KEY,
    trip_id INTEGER REFERENCES trips(id) ON DELETE CASCADE,
    driver_id INTEGER REFERENCES drivers(id),
    location GEOMETRY(Point, 4326) NOT NULL,
    speed DECIMAL(5,2), -- km/h
    heading DECIMAL(5,2), -- degrees
    accuracy DECIMAL(10,2), -- meters
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    battery_level INTEGER,
    is_online BOOLEAN DEFAULT TRUE
);

CREATE INDEX idx_location_logs_trip ON location_logs(trip_id);
CREATE INDEX idx_location_logs_timestamp ON location_logs(timestamp);
CREATE INDEX idx_location_logs_geom ON location_logs USING GIST(location);

-- ============================================
-- 6. ATTENDANCE
-- ============================================

-- Attendance records
CREATE TABLE attendance (
    id SERIAL PRIMARY KEY,
    trip_id INTEGER REFERENCES trips(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES students(id),
    stop_id INTEGER REFERENCES route_stops(id),
    attendance_type VARCHAR(20) NOT NULL, -- check_in, check_out, absent
    status VARCHAR(20) NOT NULL, -- present, absent, late
    check_time TIMESTAMP,
    location GEOMETRY(Point, 4326),
    checked_by INTEGER REFERENCES users(id),
    parent_notified BOOLEAN DEFAULT FALSE,
    notes TEXT,
    photo_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_attendance_type CHECK (attendance_type IN ('check_in', 'check_out', 'absent')),
    CONSTRAINT chk_attendance_status CHECK (status IN ('present', 'absent', 'late'))
);

CREATE INDEX idx_attendance_trip ON attendance(trip_id);
CREATE INDEX idx_attendance_student ON attendance(student_id);
CREATE INDEX idx_attendance_date ON attendance(check_time);

-- ============================================
-- 7. NOTIFICATIONS
-- ============================================

-- Notification templates
CREATE TABLE notification_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    title VARCHAR(255) NOT NULL,
    message_template TEXT NOT NULL,
    notification_type VARCHAR(50) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Notifications
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    notification_type VARCHAR(50) NOT NULL, -- info, warning, alert, success
    related_id INTEGER, -- ID of related entity (trip, student, etc)
    related_type VARCHAR(50), -- Type of related entity
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMP,
    sent_via VARCHAR(50), -- push, email, sms, in_app
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_notification_type CHECK (notification_type IN ('info', 'warning', 'alert', 'success'))
);

CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_read ON notifications(is_read);

-- ============================================
-- 8. REPORTS & STATISTICS
-- ============================================

-- Daily reports
CREATE TABLE daily_reports (
    id SERIAL PRIMARY KEY,
    report_date DATE UNIQUE NOT NULL,
    total_trips INTEGER DEFAULT 0,
    completed_trips INTEGER DEFAULT 0,
    cancelled_trips INTEGER DEFAULT 0,
    total_students_transported INTEGER DEFAULT 0,
    on_time_percentage DECIMAL(5,2),
    late_percentage DECIMAL(5,2),
    average_delay_minutes DECIMAL(10,2),
    total_distance_km DECIMAL(10,2),
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Trip performance
CREATE TABLE trip_performance (
    id SERIAL PRIMARY KEY,
    trip_id INTEGER REFERENCES trips(id) ON DELETE CASCADE,
    scheduled_duration INTEGER, -- minutes
    actual_duration INTEGER, -- minutes
    delay_minutes INTEGER,
    is_on_time BOOLEAN,
    attendance_rate DECIMAL(5,2),
    distance_km DECIMAL(10,2),
    average_speed DECIMAL(5,2),
    stops_completed INTEGER,
    issues_reported INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- 9. SYSTEM SETTINGS & BACKUP
-- ============================================

-- System settings
CREATE TABLE system_settings (
    id SERIAL PRIMARY KEY,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(50), -- string, number, boolean, json
    description TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by INTEGER REFERENCES users(id)
);

-- Backup logs
CREATE TABLE backup_logs (
    id SERIAL PRIMARY KEY,
    backup_type VARCHAR(50) NOT NULL, -- full, incremental
    backup_path VARCHAR(500),
    file_size_mb DECIMAL(10,2),
    status VARCHAR(20) NOT NULL, -- in_progress, completed, failed
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    performed_by INTEGER REFERENCES users(id),
    error_message TEXT,
    CONSTRAINT chk_backup_status CHECK (status IN ('in_progress', 'completed', 'failed'))
);

-- ============================================
-- 10. AUDIT LOGS
-- ============================================

-- Audit trail
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INTEGER,
    old_value JSONB,
    new_value JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_entity ON audit_logs(entity_type, entity_id);
CREATE INDEX idx_audit_logs_created ON audit_logs(created_at);

-- ============================================
-- VIEWS FOR REPORTING
-- ============================================

-- Active students view
CREATE VIEW v_active_students AS
SELECT 
    s.id, s.student_code, s.full_name, s.date_of_birth,
    c.name as class_name, c.grade_level,
    a.name as area_name,
    p.user_id as parent_user_id,
    u.full_name as parent_name, u.phone as parent_phone
FROM students s
LEFT JOIN classes c ON s.class_id = c.id
LEFT JOIN areas a ON s.area_id = a.id
LEFT JOIN parents p ON s.parent_id = p.id
LEFT JOIN users u ON p.user_id = u.id
WHERE s.is_active = TRUE;

-- Today's trips view
CREATE VIEW v_todays_trips AS
SELECT 
    t.id, t.trip_date, t.trip_type, t.status,
    r.route_name, r.route_code,
    v.plate_number, v.vehicle_type,
    u.full_name as driver_name,
    t.scheduled_start_time, t.actual_start_time,
    t.total_students, t.checked_in_students
FROM trips t
JOIN routes r ON t.route_id = r.id
JOIN vehicles v ON t.vehicle_id = v.id
JOIN drivers d ON t.driver_id = d.id
JOIN users u ON d.user_id = u.id
WHERE t.trip_date = CURRENT_DATE;

-- ============================================
-- FUNCTIONS & TRIGGERS
-- ============================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply trigger to tables
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_students_updated_at BEFORE UPDATE ON students
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_routes_updated_at BEFORE UPDATE ON routes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Function to calculate trip performance
CREATE OR REPLACE FUNCTION calculate_trip_performance(trip_id_param INTEGER)
RETURNS VOID AS $$
DECLARE
    scheduled_dur INTEGER;
    actual_dur INTEGER;
    delay INTEGER;
BEGIN
    SELECT 
        EXTRACT(EPOCH FROM (scheduled_end_time - scheduled_start_time))/60,
        EXTRACT(EPOCH FROM (actual_end_time - actual_start_time))/60
    INTO scheduled_dur, actual_dur
    FROM trips
    WHERE id = trip_id_param;
    
    delay := actual_dur - scheduled_dur;
    
    INSERT INTO trip_performance (trip_id, scheduled_duration, actual_duration, delay_minutes, is_on_time)
    VALUES (trip_id_param, scheduled_dur, actual_dur, delay, delay <= 5)
    ON CONFLICT (trip_id) DO UPDATE
    SET actual_duration = actual_dur, delay_minutes = delay, is_on_time = delay <= 5;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- INITIAL DATA
-- ============================================

-- Insert default admin user (password: admin123)
INSERT INTO users (username, email, password_hash, full_name, role, is_active, is_verified)
VALUES ('admin', 'admin@schoolbus.com', 'pbkdf2_sha256$600000$...', 'System Administrator', 'admin', TRUE, TRUE);

-- Insert default system settings
INSERT INTO system_settings (setting_key, setting_value, setting_type, description) VALUES
('school_name', 'ABC School', 'string', 'School name'),
('school_address', '123 Education Street', 'string', 'School address'),
('max_delay_minutes', '15', 'number', 'Maximum acceptable delay in minutes'),
('enable_push_notifications', 'true', 'boolean', 'Enable push notifications'),
('enable_sms_notifications', 'false', 'boolean', 'Enable SMS notifications'),
('backup_schedule', '02:00', 'string', 'Daily backup time (HH:MM)'),
('timezone', 'Asia/Ho_Chi_Minh', 'string', 'System timezone');